unit Usotr;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Grids, DBGrids, DBCtrls, StdCtrls, ExtCtrls;

type
  TFsotr = class(TForm)
    GroupBox1: TGroupBox;
    GroupBox2: TGroupBox;
    Label1: TLabel;
    DBLookupComboBox1: TDBLookupComboBox;
    GroupBox3: TGroupBox;
    DBGrid1: TDBGrid;
    Panel1: TPanel;
    Button1: TButton;
    Panel2: TPanel;
    Button2: TButton;
    GroupBox4: TGroupBox;
    DBGrid2: TDBGrid;
    procedure FormActivate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure DBLookupComboBox1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button1Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Fsotr: TFsotr;

implementation

uses Udm, Ureg;

{$R *.dfm}

procedure TFsotr.Button1Click(Sender: TObject);
var s:string;
begin

end;

procedure TFsotr.Button2Click(Sender: TObject);
begin
Close;
end;

procedure TFsotr.DBLookupComboBox1Click(Sender: TObject);
var sel:string;
begin
sel:='select  Zadanie.N_Zad,Zadanie.Sr_vip, Rabotnik.fio,'+
'Zadanie.St_rab, Zadanie.Data_nash, Proect.Nam_proect, Work.Nam_work'+' '+
 'from Zadanie'+' '+
 'join Proect on Zadanie.N_Proekta=Proect.N_Proekta'+' '+
 'join Rabotnik on Rabotnik.N_Rab=Zadanie.N_Rab'+' '+
 'join Work on Work.N_Work=Zadanie.N_Work'+ ' '+
  'where Zadanie.Date_fakt is null and Rabotnik.Date_yv is null and Rabotnik.N_Rab= '+
  dm.Queryrabotnik.FieldByName('N_rab').AsString;

try
dm.sel_task.Parameters.ParamByName('@n_rab').Value:=dm.Queryrabotnik.FieldByName('n_rab').AsString;
dm.sel_task.ExecProc;
dm.Querytasklist.Close;
dm.Querytasklist.SQL.Clear;
dm.Querytasklist.SQL.text:=sel;
dm.Querytasklist.Open;
dm.Querytasklist.Next;
dm.Querytasklist.first;
dm.Querytasklist.last;
except  on e:Exception do
begin
MessageDlg('сбой процедуры ',mtWarning,[mbAbort],0);
exit;
end;

end;
end;

procedure TFsotr.FormActivate(Sender: TObject);
begin
dm.Querytasklist.Open;
dm.Queryrabotnik.Open;
end;

procedure TFsotr.FormClose(Sender: TObject; var Action: TCloseAction);
begin
dm.Querytasklist.close;
dm.Queryrabotnik.Close;
end;

end.
